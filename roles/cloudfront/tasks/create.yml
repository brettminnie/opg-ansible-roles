---

- name: Create distribution with custom certificate
  cloudfront:
    type: distribution
    state: present
    wait_for_deployed: no
    policy: "{{ lookup('template', 'distribution.json') | to_json }}"
  register: cdn_distro

- name: Retrieve our cloudfront distro facts
  cloudfront_facts:
    distribution: true
    domain_name_alias: "{{ item.alias_domains.0 }}"
  register: cf_facts
  until: "{{ cf_facts['ansible_facts']['cloudfront'][item.alias_domains.0]['Distribution']['Status'] == 'Deployed' }}"
  retries: 30
  delay: 60

- name: Declare cloudfront zoneid
  set_fact:
    cf_zone_id: Z2FDTNDATAQYW2

- block:
    - name: Create alias record(s) for domain
      route53:
        command: create
        zone: "{{ opg_data.domain }}"
        value: "{{ cdn_distro.result.distribution.domain_name }}"
        record: "{{ item }}"
        type: A
        alias: yes
        overwrite: yes
        alias_hosted_zone_id: "{{ cf_zone_id }}"
        ttl: 300
      with_items: "{{ item.alias_domains }}"
