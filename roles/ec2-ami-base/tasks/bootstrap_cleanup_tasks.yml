# vim:ft=ansible
# role: opg-ansible-ec2-ami-base/tasks/bootstrap_cleanup_tasks.yml

---

- name: remove unwanted packages
  apt:
    name: "{{ item }}"
    purge: yes
    force: yes
    state: absent
  with_items:
    - apport
    - apport-symptoms
    - apt-xapian-index
    - avahi-daemon
    - avahi-utils
    - byobu
    - command-not-found*
    - cpp-doc
    - crda
    - cryptsetup*
    - cups
    - debconf-i18n
    - debian-faq*
    - debian-faq-de
    - debian-faq-fr
    - debian-faq-it
    - debian-faq-zh-cn
    - doc-debian
    - dosfstools
    - ed
    - efibootmgr
    - eject
    - fdutils
    - finger
    - fonts-ubuntu-font-family-console
    - foomatic-filters
    - friendly-recovery
    - g++
    - gcc-doc
    - grub-efi-amd64
    - grub-efi-amd64-signed
    - hplip
    - iamerican
    - ibritish
    - info
    - install-info
    - installation-report
    - iw
    - krb5-locales
    - laptop-detect
    - libx11-6
    - libx11-data
    - libxcb1
    - libxext6
    - libxmuu1
    - man-db
    - manpages
    - manpages-dev
    - mlocate
    - modemmanager
    - mutt
    - ntfs-3g
    - plymouth-theme-ubuntu-text
    - policykit-1
    - pollinate
    - popularity-contest
    - powermgmt-base
    - ppp
    - pppoeconf
    - python-zeitgeist
    - read-edid
    - reportbug
    - rhythmbox-plugin-zeitgeist
    - run-one
    - sbsigntool
    - screen
    - secureboot-db
    - shim-signed
    - ubuntu-release-upgrader-core*
    - unity-lens-shopping
    - update-manager-core*
    - update-notifier-common
    - usbutils
    - virtualbox*
    - virtualbox-guest-dkms
    - virtualbox-guest-utils
    - virtualbox-guest-x11
    - w3m
    - wamerican
    - whoopsie
    - wireless-regdb
    - wireless-tools
    - wpasupplicant
    - xauth
    - zeitgeist
    - zeitgeist-core
    - zeitgeist-datahub
    - zeroinstall-injector
    - open-vm-tools

- name: run cleanup tasks
  shell: "{{ item }}"
  with_items:
    - dpkg -l | egrep '^rc' | awk '{ print $2 }' | xargs apt-get -y purge
    - dpkg -l | awk '{ print $2 }' | egrep 'linux-(source|headers)' | grep -v "$(uname -r | sed -e 's/\-generic//;s/\-lowlatency//')" | xargs apt-get -y purge
    - dpkg -l | awk '{ print $2 }' | grep 'linux-image-[a-df-z].*-generic' | grep -v $(uname -r) | xargs apt-get -y purge
    - for f in /etc/init/tty*.conf; do dpkg-divert --rename $f; done
    - for f in /etc/init/plymouth*.conf; do dpkg-divert --rename $f; done
    - for f in /etc/init/hwclock*.conf; do dpkg-divert --rename $f; done
    - apt-get -y --purge autoremove
    - apt-get -y autoclean
    - apt-get -y clean all
    - rm -f VBoxGuestAdditions_*.iso VBoxGuestAdditions_*.iso.?Â¬
    - rm -f /boot/grub/menu.lst_*
    - rm -f /root/.bash_history
    - rm -f /root/.rnd*
    - rm -f /root/.hushlogin
    - rm -f /root/*.tar
    - rm -f /root/.*_history
    - rm -f /root/.lesshst
    - rm -f /root/.gemrc
    - rm -rf /root/.cache
    - rm -rf /root/.{gem,gems}
    - rm -rf /root/.vim*
    - rm -rf /root/.ssh
    - rm -rf /root/*
    - rm -f /home/ubuntu/.bash_history
    - rm -f /home/ubuntu/.rnd*
    - rm -f /home/ubuntu/.hushlogin
    - rm -f /home/ubuntu/*.tar
    - rm -f /home/ubuntu/.*_history
    - rm -f /home/ubuntu/.lesshst
    - rm -f /home/ubuntu/.gemrc
    - rm -rf /home/ubuntu/.cache
    - rm -rf /home/ubuntu/.{gem,gems}
    - rm -rf /home/ubuntu/.vim*
    - rm -rf /home/ubuntu/*
    - rm -rf /usr/share/{doc,man}/*
      #- find /opt/*/share -type d -name 'man' -exec rm -rf '{}' \;
    - rm -rf /tmp/* /var/tmp/*
    - rm -f /etc/apt/apt.conf.d/00CDMountPoint
    - rm -rf /var/lib/ubuntu-release-upgrader
    - rm -rf /var/lib/update-notifier
    - rm -rf /var/lib/update-manager
    - rm -rf /var/lib/man-db
    - rm -rf /var/lib/apt-xapian-index
    - rm -rf /var/lib/ntp/ntp.drift
    - rm -rf rm -rf /lib/recovery-mode
    - rm -rf /var/lib/cloud/data/script
    - rm -rf /var/lib/cloud/scripts/per-instance
    - rm -rf /var/lib/cloud/data/user-data*
    - rm -rf /dev/.udev
    - rm -rf /var/lib/{dhcp,dhcp3}/*
    - find /etc /var /usr -type f -name '*~' -exec rm -f '{}' \; || true
    - find /var/log /var/cache /var/lib/apt -type f -exec rm -rf '{}' \;
    - mkdir -p /var/lib/apt/periodic
    - mkdir -p /var/lib/apt/{lists,archives}/partial
    - chown -R root:root /var/lib/apt
    - chmod -R 755 /var/lib/apt
    - apt-cache gencaches
    - touch /var/log/{lastlog,wtmp,btmp}
    - chown root:root /var/log/{lastlog,wtmp,btmp}
    - chmod 644 /var/log/{lastlog,wtmp,btmp}
  when: True
  tags:
    - skip_ansible_lint

- name: disable ondemand
  service:
    name: ondemand
    enabled: no
    state: stopped
