# vim:ft=ansible
# role: ec2-ami-base/tasks/bootstrap_install_salt.yml

---

# disable salt-minion, as it is run through cloud-init
# so that the relevant salt-minion id is only generated at that point-in-time.
- name: disable salt-minion on startup
  service:
    name: salt-minion
    state: stopped
    enabled: no

- name: create salt dirs
  file:
    path: /etc/salt/pki/minion
    recurse: yes
    state: directory

- name: remove salt files
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /etc/salt/minion_id
    - /etc/salt/pki/minion/*

- name: enable tcp keepalive on salt_minions
  lineinfile:
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    dest: "/etc/salt/minion"
  with_items:
    - { regexp: ".*tcp_keepalive:.*", line: "tcp_keepalive: True" }
    - { regexp: ".*tcp_keepalive_idle:.*", line: "tcp_keepalive_idle: 300" }
